name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Prevent multiple simultaneous runs against the shared backend
concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────
  # Job 1: API Tests (Python + pytest)
  # ──────────────────────────────────────────────
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: test/api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: test/api/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run API tests
        env:
          BASE_URL: "https://wmxrwq14uc.execute-api.us-east-1.amazonaws.com/Prod"
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: pytest --html=report.html --self-contained-html

      - name: Upload API test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: test/api/report.html
          retention-days: 14

  # ──────────────────────────────────────────────
  # Job 2: E2E Tests (Node + Playwright)
  # Runs AFTER api-tests to avoid data conflicts
  # against the shared backend.
  # Always runs regardless of api-tests outcome.
  # ──────────────────────────────────────────────
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [api-tests]
    if: always()
    defaults:
      run:
        working-directory: test/e2e

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: test/e2e/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        env:
          CI: "true"
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: test/e2e/playwright-report/
          retention-days: 14

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test/e2e/test-results/
          retention-days: 14

  # ──────────────────────────────────────────────
  # Final status gate — useful for branch protection
  # Reports unified pass/fail across both suites.
  # ──────────────────────────────────────────────
  test-results:
    name: Test Results
    runs-on: ubuntu-latest
    if: always()
    needs: [api-tests, e2e-tests]

    steps:
      - name: Check API tests result
        if: needs.api-tests.result == 'failure'
        run: echo "::error::API tests failed" && exit 1

      - name: Check E2E tests result
        if: needs.e2e-tests.result == 'failure'
        run: echo "::error::E2E tests failed" && exit 1

      - name: All tests passed
        run: echo "All test suites passed successfully"
